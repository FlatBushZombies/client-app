"use client"

import { useUser } from "@clerk/clerk-expo"
import { Ionicons } from "@expo/vector-icons"
import { router } from "expo-router"
import { useEffect, useState } from "react"
import {
  ActivityIndicator,
  FlatList,
  RefreshControl,
  SafeAreaView,
  Text,
  TouchableOpacity,
  View,
} from "react-native"
import { useSocket } from "@/contexts/SocketContext"

interface Application {
  id: number
  jobId: number
  freelancerClerkId: string
  freelancerName: string
  freelancerEmail: string
  status: "pending" | "accepted" | "rejected"
  createdAt: string
}

interface Job {
  id: number
  serviceType: string
  maxPrice: number
  applications: Application[]
}

const ApplicationsScreen = () => {
  const { user } = useUser()
  const { notifications, markAsRead, unreadCount } = useSocket()
  const [jobs, setJobs] = useState<Job[]>([])
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [updatingStatus, setUpdatingStatus] = useState<number | null>(null)

  const fetchJobsWithApplications = async () => {
    try {
      console.log('[Applications] Starting fetch for user:', user?.id)
      
      if (!user?.id) {
        console.error('[Applications] No user ID available')
        setJobs([])
        setLoading(false)
        setRefreshing(false)
        return
      }

      // First, fetch all jobs created by this user
      const jobsUrl = `https://quickhands-api.vercel.app/api/jobs?clerkId=${user.id}`
      console.log('[Applications] Fetching jobs from:', jobsUrl)
      
      const jobsResponse = await fetch(jobsUrl)
      const jobsData = await jobsResponse.json()
      
      console.log('[Applications] Jobs response:', {
        status: jobsResponse.status,
        success: jobsData.success,
        count: jobsData.data?.length || 0
      })

      if (!jobsResponse.ok || !jobsData.success) {
        console.error('[Applications] Failed to fetch jobs:', jobsData)
        setJobs([])
        return
      }

      if (!jobsData.data || jobsData.data.length === 0) {
        console.log('[Applications] User has no jobs posted')
        setJobs([])
        return
      }

      // Get auth token once
      const token = await user.getToken()
      console.log('[Applications] Got auth token:', token ? 'yes' : 'no')

      // For each job, fetch its applications
      const jobsWithApps = await Promise.all(
        jobsData.data.map(async (job: any) => {
          try {
            const appsUrl = `https://quickhands-api.vercel.app/api/jobs/${job.id}/applications`
            console.log(`[Applications] Fetching apps for job ${job.id}:`, job.serviceType)
            
            const appsResponse = await fetch(appsUrl, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
            })
            
            const appsData = await appsResponse.json()
            
            console.log(`[Applications] Job ${job.id} apps:`, {
              status: appsResponse.status,
              success: appsData.success,
              count: appsData.data?.length || 0
            })

            return {
              id: job.id,
              serviceType: job.serviceType,
              maxPrice: job.maxPrice,
              applications: (appsResponse.ok && appsData.success) ? appsData.data : [],
            }
          } catch (error) {
            console.error(`[Applications] Error fetching apps for job ${job.id}:`, error)
            return {
              id: job.id,
              serviceType: job.serviceType,
              maxPrice: job.maxPrice,
              applications: [],
            }
          }
        })
      )

      // Filter to only show jobs that have applications
      const jobsWithActiveApps = jobsWithApps.filter((job) => job.applications.length > 0)
      
      console.log('[Applications] Final result:', {
        totalJobs: jobsWithApps.length,
        jobsWithApps: jobsWithActiveApps.length,
        totalApplications: jobsWithActiveApps.reduce((sum, job) => sum + job.applications.length, 0)
      })
      
      setJobs(jobsWithActiveApps)
    } catch (error) {
      console.error('[Applications] Fatal error fetching jobs with applications:', error)
      setJobs([])
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  useEffect(() => {
    if (user?.id) {
      fetchJobsWithApplications()
    }
  }, [user?.id])

  const onRefresh = () => {
    setRefreshing(true)
    fetchJobsWithApplications()
  }

  const updateApplicationStatus = async (applicationId: number, status: "accepted" | "rejected") => {
    setUpdatingStatus(applicationId)
    try {
      const response = await fetch(
        `https://quickhands-api.vercel.app/api/applications/${applicationId}/status`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${await user?.getToken()}`,
          },
          body: JSON.stringify({ status }),
        }
      )

      const data = await response.json()

      if (data.success) {
        // Update local state
        setJobs((prevJobs) =>
          prevJobs.map((job) => ({
            ...job,
            applications: job.applications.map((app) =>
              app.id === applicationId ? { ...app, status } : app
            ),
          }))
        )
      }
    } catch (error) {
      console.error("Error updating application status:", error)
    } finally {
      setUpdatingStatus(null)
    }
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    })
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case "accepted":
        return "#10B981"
      case "rejected":
        return "#EF4444"
      default:
        return "#F59E0B"
    }
  }

  const renderApplication = (application: Application, job: Job) => (
    <View
      key={application.id}
      style={{
        backgroundColor: "#FFF",
        borderRadius: 16,
        padding: 16,
        marginBottom: 12,
        borderWidth: 1,
        borderColor: "#E5E7EB",
      }}
    >
      <View style={{ flexDirection: "row", justifyContent: "space-between", marginBottom: 8 }}>
        <View style={{ flex: 1 }}>
          <Text style={{ fontSize: 16, fontWeight: "700", color: "#111827", marginBottom: 4 }}>
            {application.freelancerName}
          </Text>
          <Text style={{ fontSize: 13, color: "#6B7280", marginBottom: 2 }}>
            {application.freelancerEmail}
          </Text>
          <Text style={{ fontSize: 12, color: "#9CA3AF" }}>
            Applied {formatDate(application.createdAt)}
          </Text>
        </View>
        <View
          style={{
            backgroundColor: getStatusColor(application.status) + "20",
            paddingHorizontal: 12,
            paddingVertical: 6,
            borderRadius: 12,
            alignSelf: "flex-start",
          }}
        >
          <Text
            style={{
              fontSize: 12,
              fontWeight: "600",
              color: getStatusColor(application.status),
              textTransform: "capitalize",
            }}
          >
            {application.status}
          </Text>
        </View>
      </View>

      {application.status === "pending" && (
        <View style={{ flexDirection: "row", gap: 8, marginTop: 12 }}>
          <TouchableOpacity
            onPress={() => updateApplicationStatus(application.id, "accepted")}
            disabled={updatingStatus === application.id}
            style={{
              flex: 1,
              backgroundColor: "#10B981",
              paddingVertical: 12,
              borderRadius: 12,
              alignItems: "center",
            }}
          >
            {updatingStatus === application.id ? (
              <ActivityIndicator color="#FFF" size="small" />
            ) : (
              <Text style={{ color: "#FFF", fontSize: 14, fontWeight: "600" }}>Accept</Text>
            )}
          </TouchableOpacity>
          <TouchableOpacity
            onPress={() => updateApplicationStatus(application.id, "rejected")}
            disabled={updatingStatus === application.id}
            style={{
              flex: 1,
              backgroundColor: "#EF4444",
              paddingVertical: 12,
              borderRadius: 12,
              alignItems: "center",
            }}
          >
            {updatingStatus === application.id ? (
              <ActivityIndicator color="#FFF" size="small" />
            ) : (
              <Text style={{ color: "#FFF", fontSize: 14, fontWeight: "600" }}>Reject</Text>
            )}
          </TouchableOpacity>
        </View>
      )}
    </View>
  )

  const renderJob = ({ item: job }: { item: Job }) => (
    <View style={{ marginBottom: 24 }}>
      <View
        style={{
          backgroundColor: "#F9FAFB",
          padding: 16,
          borderRadius: 16,
          marginBottom: 12,
        }}
      >
        <Text style={{ fontSize: 18, fontWeight: "700", color: "#111827", marginBottom: 4 }}>
          {job.serviceType}
        </Text>
        <Text style={{ fontSize: 14, color: "#6B7280" }}>
          ${job.maxPrice}/h â€¢ {job.applications.length} application
          {job.applications.length !== 1 ? "s" : ""}
        </Text>
      </View>
      {job.applications.map((app) => renderApplication(app, job))}
    </View>
  )

  if (loading) {
    return (
      <SafeAreaView style={{ flex: 1, backgroundColor: "#FAFAFA" }}>
        <View style={{ flex: 1, alignItems: "center", justifyContent: "center" }}>
          <ActivityIndicator size="large" color="#2563EB" />
        </View>
      </SafeAreaView>
    )
  }

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: "#FAFAFA" }}>
      {/* Header */}
      <View
        style={{
          flexDirection: "row",
          alignItems: "center",
          justifyContent: "space-between",
          paddingHorizontal: 20,
          paddingVertical: 16,
          backgroundColor: "#FFF",
          borderBottomWidth: 1,
          borderBottomColor: "#E5E7EB",
        }}
      >
        <TouchableOpacity
          onPress={() => router.back()}
          style={{
            width: 40,
            height: 40,
            borderRadius: 12,
            backgroundColor: "#F3F4F6",
            alignItems: "center",
            justifyContent: "center",
          }}
        >
          <Ionicons name="arrow-back" size={20} color="#111827" />
        </TouchableOpacity>
        <Text style={{ fontSize: 18, fontWeight: "700", color: "#111827" }}>Applications</Text>
        <View style={{ width: 40 }} />
      </View>

      {/* Notifications Summary */}
      {unreadCount > 0 && (
        <View
          style={{
            backgroundColor: "#DBEAFE",
            paddingHorizontal: 16,
            paddingVertical: 12,
            marginHorizontal: 16,
            marginTop: 16,
            borderRadius: 12,
            flexDirection: "row",
            alignItems: "center",
          }}
        >
          <Ionicons name="notifications" size={20} color="#2563EB" />
          <Text style={{ marginLeft: 8, fontSize: 14, color: "#1E40AF", flex: 1 }}>
            You have {unreadCount} new notification{unreadCount !== 1 ? "s" : ""}
          </Text>
        </View>
      )}

      {/* Applications List */}
      {jobs.length === 0 ? (
        <View style={{ flex: 1, alignItems: "center", justifyContent: "center", padding: 20 }}>
          <Ionicons name="briefcase-outline" size={64} color="#D1D5DB" />
          <Text style={{ fontSize: 18, fontWeight: "600", color: "#6B7280", marginTop: 16 }}>
            No applications yet
          </Text>
          <Text
            style={{
              fontSize: 14,
              color: "#9CA3AF",
              textAlign: "center",
              marginTop: 8,
            }}
          >
            When freelancers apply to your jobs, you'll see them here
          </Text>
        </View>
      ) : (
        <FlatList
          data={jobs}
          renderItem={renderJob}
          keyExtractor={(item) => item.id.toString()}
          contentContainerStyle={{ padding: 16 }}
          refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}
        />
      )}
    </SafeAreaView>
  )
}

export default ApplicationsScreen
